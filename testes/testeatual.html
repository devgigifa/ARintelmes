
<!-- 
atual versão main4 para edição 
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AR Intelmes</title>
    <link rel="icon" href="https://img.icons8.com/ios_filled/200/40C057/info.png">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <script>

        async function initAR() {
            const scene = document.querySelector("#a-scene");
            scene.style.display = "block"; 

            const components = ["cycletime", "operationcode", "quantity", "quantityprod", "scrapquantity", "goodquantity", "perf", "nextop", "rescode", "itemtool", "item", "status"];
            const qrCodeResponse = 'D0:EF:76:45:ED:DF'; //endereço de MAC

            if (qrCodeResponse) {
                try {
                    const intelmountAPIResponse = await fetch(`https://intelmount.apps.intelbras.com.br/v1/resources/mount?mac=${qrCodeResponse}`);
                    if (intelmountAPIResponse.ok) {
                        const data = await intelmountAPIResponse.json();
                        const status = data?.data[0]?.orders?.currents[0]?.status || "stop";
                        console.log(data?.data?.[0].code, data?.data[0]?.orders?.currents[0]?.operationId);
                        updateMachineStatus(status);

                        const machineDetails = {
                            cycletime: (data?.data[0]?.orders?.currents[0]?.item?.factor),
                            operationcode: (data?.data[0]?.orders?.currents[0]?.operationId),
                            quantity: (data?.data[0]?.orders?.currents[0]?.production?.meta),
                            quantityprod: (data?.data[0]?.orders?.currents[0]?.production?.current),
                            scrapquantity: (data?.data[0]?.orders?.currents[0]?.production?.refuge),
                            goodquantity: ((data?.data[0]?.orders?.currents[0]?.production?.current) - (data?.data[0]?.orders?.currents[0]?.production?.refuge)),
                            perf: `perf: ${(data?.data[0]?.orders?.currents[0]?.perf).toFixed(2)}%`,
                            nextop: `Proxima OP: ${"5607040-2"}`,
                            rescode: (data?.data?.[0].code),
                            itemtool: (data?.data[0]?.orders?.currents[0]?.item?.tool),
                            item: `${(data?.data[0]?.orders?.currents[0]?.item?.code)} - ${(data?.data[0]?.orders?.currents[0]?.item?.name)}`,
                            status: (data?.data[0]?.orders?.currents[0]?.status),
                        }

                        for (const component of components) {
                            const element = document.getElementById(component);
                            if (element) {
                                element.setAttribute("value", machineDetails[component]);
                            }
                        }
                    }
                    // updateMachineStatus(machineDetails.status, machineDetails);
                } catch (error) {
                    console.error("Failed to fetch data:", error);
                }
            }
        }

        async function updateMachineStatus(status, machineDetails) {
            const grandbox = document.getElementById("grandbox");
            const elementsToHide = ["cycletime", "operationcode", "quantity", "quantityprod", "scrapquantity", "goodquantity", "prodNum", "tc", "op", "qtd", "qtdboa", 'qtdprod', 'ref'];
            const statusEl = document.getElementById("status");
            const itemEl = document.getElementById("item");
            const barEl = document.getElementById("production-bar");
            const rescodeEl = document.getElementById("rescode");
            
            let productionValue = 0;
            document.getElementById("rescode").setAttribute("visible", "true");
            
            if (status === "production") {
                // Estado de Produção
                grandbox.setAttribute("color", "#00a335");
                statusEl.setAttribute("value", "PRODUCAO");
                productionValue = prodNum()

                // Cálculo da barra de produção considerando o valor de refuge
                // const { quantity, quantityprod, scrapquantity: refuge } = machineDetails;
                // const total = quantity || 1; // Evitar divisão por zero

                // if (!refuge) {
                //     const calc = (quantity / total) * 100;
                //     return calc;
                // }
                // const calc = ((quantity - refuge) / total) * 100;


            } else if (status === "parada") {
                // Estado Parada com ordem
                grandbox.setAttribute("color", "#d72735");
                statusEl.setAttribute("value", "PARADA COM ORDEM");
                barEl.setAttribute("color", "#b4212c")
                productionValue = 0; 

                for (const id of elementsToHide) {
                    document.getElementById(id).setAttribute("visible", "true");
                }
                document.getElementById("perf").setAttribute("visible", "true");

            } else if (status === "stop") {
                // Estado Fora de Turno
                grandbox.setAttribute("color", "#adb3b7");
                statusEl.setAttribute("value", "PARADO");
                itemEl.setAttribute("value", "FORA DE TURNO MAQUINA DESLIGADA PLANEJADA");
                productionValue = 100; 
                barEl.setAttribute("color", "#8f9ca4")
                rescodeEl.setAttribute("value", "TESTE");

                for (const id of elementsToHide) {
                    document.getElementById(id).setAttribute("visible", "false");
                }
                document.getElementById("perf").setAttribute("visible", "false");
                // document.getElementById("rescode").setAttribute("visible", "true");
            }

            updateProductionBar(productionValue);
        }

function updateProductionBar(value) {
    const barFill = document.getElementById("production-bar");

    if (barFill) {
        const fillScale = value / 100;
        barFill.setAttribute("scale", `${fillScale * 1.3} 0.1 0.1`);
        barFill.setAttribute("position", `${(fillScale * 1.3 / 2) - 0.65} 0 0`);
    }
}

    document.addEventListener('DOMContentLoaded', () => {
        const gaugesGroup = document.getElementById("gauges-group");
        gaugesGroup.setAttribute("visible", "true"); 
        initGauges();
        productionBar();
        initAR(); 
    });


        // FUNCTION GAUGES

        // Função para gerar um valor aleatório entre dois números
        function getRandomValue(min, max) {
            return Math.random() * (max - min) + min;
        }

        // Atualiza os gauges gradualmente
        function simulateGaugeChange(textId, ringId, currentValue) {
            const newValue = getRandomValue(0, 100);
            let step = (newValue - currentValue) / 100;

            const interval = setInterval(() => {
                if (Math.abs(newValue - currentValue) < Math.abs(step)) {
                    currentValue = newValue;
                    clearInterval(interval);
                } else {
                    currentValue += step;
                }
                updateGauge(currentValue, textId, ringId);
            }, 100); // Atualiza a cada 50ms para uma transição suave
        }

        // Inicializa os gauges
        function initGauges() {
            let OEEValue = 100, DispValue = 100, PerfValue = 100, QualValue = 100;

            setInterval(() => {
                simulateGaugeChange('text-OEE', 'ring-OEE', OEEValue);
                simulateGaugeChange('text-Disponibilidade', 'ring-Disponibilidade', DispValue);
                simulateGaugeChange('text-Performance', 'ring-Performance', PerfValue);
                simulateGaugeChange('text-Qualidade', 'ring-Qualidade', QualValue);
            }, 10000);
        }

        // Atualiza os gauges
        function updateGauge(value, textId, ringId) {
            const textEntity = document.getElementById(textId);
            const ringEntity = document.getElementById(ringId);

            if (textEntity && ringEntity) {
                textEntity.setAttribute('value', textId.split('-')[1] + ': ' + Math.round(value) + '%');

                const greenValue = Math.floor((value / 100) * 255);
                const redValue = 255 - greenValue;
                const color = `rgb(${redValue}, ${greenValue}, 0)`;
                ringEntity.setAttribute('color', color);

                const thetaLength = (value / 100) * 360;
                ringEntity.setAttribute('theta-length', thetaLength);
            } else {
                console.warn("Element not found:", textId, ringId);
            }
        }

        // Funções que atualizam a barra de preenchimento para manter a escala correta
        // function updateProductionBar(value) {
        //     const barFill = document.getElementById("production-bar");

        //     if (barFill) {
        //         const fillScale = value / 100; 
        //         barFill.setAttribute("scale", `${fillScale * 1.3} 0.1 0.1`); 
        //         barFill.setAttribute("position", `${(fillScale * 1.3 / 2) - 0.65} 0 0`); 
        //     }

        //     // if (!refuge) {
        //     //     const calc = (quantity / total) * 100;
        //     //     return calc;
        //     // }
        //     // const calc = ((quantity - refuge) / total) * 100;
        // }

        // function productionBar() {
        //     let productionValue = 0;
        //     let step = 1; 

        //     const interval = setInterval(() => {
        //         if (productionValue >= 100) {
        //             productionValue = 0;
        //         } else {
        //             productionValue += step;
        //         }
        //         updateProductionBar(productionValue);
        //     }, 100); 
        // }

        function prodNum(){
            if (!refuge) {
                const calc = (quantity / total) * 100;
                return calc;
            }
            const calc = ((quantity - refuge) / total) * 100;
        }


    </script>

    <style>
        #a-scene {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <a-scene
        id="a-scene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        camera="position: 0 1.6 0; fov: 80; near: 0.1"   init-ar initGauges productionBar
    >

        <a-box
            id="grandbox"
            position="0 1.25 -3"
            rotation="0 0 0"
            color="#00a335"
            scale="2 1 0.5"
            frustumCulled="false"
        >
        </a-box>

        <a-text
            id="hours"
            value="4 h" 
            color="white" 
            width="1.3"
            scale="1.2 0.7 1.2" 
            position="-0.7 1.65 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>

        <a-text
            id="perf"
            color="white" 
            width="1.3"
            scale="1 0.5 1" 
            position="0.5 1.65 -2.4"
            frustumCulled="false"
        >
        </a-text>
        <a-text
            id="itemtool"
            color="white" 
            width="1.3"
            scale="1 0.5 1" 
            position="0.5 1.60 -2.4"
            frustumCulled="false"
        >
        </a-text>

        <a-text
            id="rescode"
            color="white" 
            width="1.3"
            scale="3 1.8 3" 
            position="0 1.57 -2.4" 
            align="center"
            frustumCulled="false"        
        >
        </a-text>

        <a-text
            id="status"
            color="white" 
            width="1.3"
            scale="2.3 1 2.3" 
            position="0 1.43 -2" 
            align="center"
            frustumCulled="false"
        >
        </a-text>
    
        <!-- Barra de Produção -->
        <a-entity position="0 1.43 -2.2" frustumCulled="false">
            <a-box 
                position="0 0 0"  
                scale="0 0.1 0.1"  
                color="darkgreen" 
                id="production-bar"
            ></a-box>
        </a-entity>

        <a-text 
            id="prodNum"
            value="33%"
            color="white" 
            width="1.3"
            scale="1.5 0.9 1.5" 
            position="0 1.3 -2.4" 
            align="center"
            frustumCulled="false"
            prodNum
        >
        </a-text>  

        <a-entity line="start: -0.8 1.25 -2.4; end: 0.8 1.25 -2.4; color: white"></a-entity>

        <a-text 
            value="TC" 
            id="tc" 
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.75 1.2 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>
        <a-text 
            id="cycletime"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.75 1.15 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>  

        <a-text 
            value="OP" 
            id="op" 
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.45 1.2 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>
        <a-text 
            id="operationcode"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.45 1.15 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>  

        <a-text 
            value="QTD"
            id="qtd"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.15 1.2 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>
        <a-text 
            id="quantity"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.15 1.15 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>  

        <a-text 
            value="QTD PROD" 
            id="qtdprod"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="0.14 1.2 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>
        <a-text 
            id="quantityprod"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="0.14 1.15 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>  

        <a-text 
            value="REF"
            id="ref"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="0.40 1.2 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>
        <a-text 
            id="scrapquantity"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="0.40 1.15 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>

        <a-text 
            value="QTD BOA"
            id="qtdboa"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="0.65 1.2 -2.4" 
            align="center" 
            frustumCulled="false"
        >
        </a-text>
        <a-text 
            id="goodquantity"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="0.65 1.15 -2.4" 
            align="center"
            frustumCulled="false"
        >
        </a-text>

        <a-entity line="start: -0.8 1.1 -2.4; end: 0.8 1.1 -2.4; color: white" frustumCulled="false"></a-entity>

        <a-text
            id="item"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.8 1.05 -2.4" 
            align="left" 
            frustumCulled="false"
        >
        </a-text>

        <a-text
            id="nextop"
            color="white" 
            width="1.3"
            scale="1.2 0.8 1.2" 
            position="-0.8 0.93 -2.4" 
            align="left" 
            frustumCulled="false"
        >
        </a-text> 

    <!-- GAUGES -->
     <!-- position vertical dos gauges mudada de 0.2 para 0.5 -->
    <a-entity 
        id="gauges-group" frustumCulled="false" 
    >
        <a-entity 
            id="gauge-OEE" 
            position="-1.1 0.5 -2.4"  
            scale="0.35 0.35 0.35"
        >
            <a-ring 
                id="ring-OEE" 
                color="blue" 
                radius-inner="0.35" 
                radius-outer="0.45"  
                theta-start="0" 
                theta-length="0"
            ></a-ring>
            <a-text 
                id="text-OEE" 
                value="OEE: 100%" 
                position="0 0.6 0" 
                align="center" 
                color="white"
            ></a-text>
        </a-entity>

        <a-entity 
            id="gauge-Disponibilidade" 
            position="-0.4 0.5 -2.4"  
            scale="0.35 0.35 0.35"  
        >
            <a-ring 
                id="ring-Disponibilidade" 
                color="orange" 
                radius-inner="0.35" 
                radius-outer="0.45"  
                theta-start="0" 
                theta-length="0"
            ></a-ring>
            <a-text 
                id="text-Disponibilidade" 
                value="Disp: 100%" 
                position="0 0.6 0" 
                align="center" 
                color="white"
            ></a-text>
        </a-entity>

        <a-entity 
            id="gauge-Performance" 
            position="0.4 0.5 -2.4"  
            scale="0.35 0.35 0.35"  
        >
            <a-ring 
                id="ring-Performance" 
                color="green" 
                radius-inner="0.35" 
                radius-outer="0.45"  
                theta-start="0" 
                theta-length="0"
            ></a-ring>
            <a-text 
                id="text-Performance" 
                value="Perf: 100%" 
                position="0 0.6 0" 
                align="center" 
                color="white"
            ></a-text>
        </a-entity>

        <a-entity 
            id="gauge-Qualidade" 
            position="1.1 0.5 -2.4"  
            scale="0.35 0.35 0.35"  
        >
            <a-ring 
                id="ring-Qualidade" 
                color="yellow" 
                radius-inner="0.35" 
                radius-outer="0.45"  
                theta-start="0" 
                theta-length="0"
            ></a-ring>
            <a-text 
                id="text-Qualidade" 
                value="Qual: 100%" 
                position="0 0.6 0" 
                align="center" 
                color="white"
            ></a-text>
        </a-entity>
    </a-entity>
</a-scene>

    <script>
        navigator.mediaDevices
            .getUserMedia({ video: true })
            .then(initAR)
            .catch((err) => alert("Permissão de câmera negada:", err));
    </script>
</body>
</html>